# Setup Windows

## Set preference for specific network interface

1. Run windows terminal with powershell as administrator and execute command to get info about interfaces metric:
```powershell
Get-NetIPInterface -AddressFamily IPv4
```

2. Add interface metric:
```powershell
Set-NetIPInterface -InterfaceIndex <Specify an index> -InterfaceMetric <Specify a metric>
```

> [!NOTE]
> [`InterfaceMetric`](https://learn.microsoft.com/en-us/powershell/module/nettcpip/set-netipinterface?view=windowsserver2022-ps) - Specifies a metric for an IP interface. When routes are chosen, the overall metric used to determine the preference is the sum of the route metric and the interface metric. Typically, the interface metric gives preference to a particular interface, such as using wired if both wired and wireless are available. This parameter value uses the value generated by AutomaticMetric by default. If this parameter value is set, then the AutomaticMetric parameter is automatically disabled.

3. Restart the network device:
```powershell
Restart-NetAdapter -InterfaceAlias "Specify an IneterfaceAlias"
```

Close Windows Terminal.

## Install PowerShell

1. Run windows terminal with powershell and update system apps: 
```powershell
winget update --id Microsoft.WindowsTerminal -e --accept-source-agreements --source winget; if ($?) { winget update --id Microsoft.AppInstaller -e --source winget };
```

2. Restart windows terminal and install Microsoft powershell:
```powershell
winget install --id Microsoft.PowerShell -e --source winget
```

3. Restart Terminal again and setup default profile as `powershell`.

## Install apps

1. Run windows terminal as administrator and create list of apps:
```powershell
notepad.exe .\PowerShellInstall_Winget_Machine.ps1
```

```ps1
winget install --id Git.Git -e --source winget;
if ($?) { winget install --id Microsoft.VCRedist.2015+.x64 -e --source winget };
if ($?) { winget install --id Skillbrains.Lightshot -e --source winget };
if ($?) { winget install --id qBittorrent.qBittorrent -e --source winget };
if ($?) { winget install --id Neovim.Neovim -e --source winget };
if ($?) { winget install --id 7zip.7zip -e --source winget };
if ($?) { winget install --id Mozilla.Firefox -e --source winget };
if ($?) { winget install --id ALCPU.CoreTemp -e --source winget };
if ($?) { winget install --id Starship.Starship -e --source winget };
if ($?) { winget install --id DEVCOM.JetBrainsMonoNerdFont -e --source winget };
if ($?) { winget install --id Mozilla.Thunderbird -e --source winget };
if ($?) { winget install --id gerardog.gsudo -e --source winget };
if ($?) { winget install --id Bitwarden.Bitwarden -e --source winget };
if ($?) { winget install --id Telegram.TelegramDesktop -e --source winget };
if ($?) { winget install --id Microsoft.VisualStudioCode -e --source winget };
if ($?) { winget install --id Obsidian.Obsidian -e --source winget };
```

2. Execute powershell script:
```powershell
.\PowerShellInstall_Winget_Machine.ps1
```

## Enable Hyper-V and WSL

1. Run terminal as administrator to enable WSL and Hyper-V:
```powershell
wsl --install
```

```powershell
Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All
```

2. After reboot install OS Linux into WSL:
```powershell
wsl --install
```

## Install powershell modules

1. Run windows terminal and create list of apps:
```powershell
notepad.exe .\PowerShellInstall_Modules.ps1
```

```powershell
Install-Module -Name posh-git -Scope CurrentUser;
if ($?) { Install-Module -Name z -Scope CurrentUser };
if ($?) { Install-Module -Name PSReadLine -Scope CurrentUser };
if ($?) { Install-Module -Name Terminal-Icons -Scope CurrentUser };
```

2. Execute powershell script:
```powershell
.\PowerShellInstall_Modules.ps1
```

## Delete installation files

```powershell
Remove-Item $env:USERPROFILE\PowerShellInstall_*.ps1
```

## Setup PowerShell

### Add profile

#### Types

- Current User, Current Host - `$PROFILE`, `$PROFILE.CurrentUserCurrentHost`
- Current User, All Hosts - `$PROFILE.CurrentUserAllHosts`
- All Users, Current Host - `$PROFILE.AllUsersCurrentHost`
- All Users, All Hosts - `$PROFILE.AllUsersAllHosts`

1. Create profile:
```powershell
if (!(Test-Path -Path $PROFILE)) {
  New-Item -ItemType File -Path $PROFILE -Force
}
```

2. Edit profile:
```powershell
notepad.exe $PROFILE
```

```ps1
# import ps modules
Import-Module -Name PSReadLine
Import-Module -Name z
Import-Module -Name Terminal-Icons
Import-Module -Name posh-git

# functions
Function WingetInstall {
  sudo winget install --source winget --id $(Read-Host -Prompt 'Enter Package Name') -e
}
Function WingetUninstall {
  sudo winget uninstall --id $(Read-Host -Prompt 'Enter Package Name') -e
}
Function WingetSearch {
  winget search $(Read-Host -Prompt 'Enter Package Name')
}
Function SSHPubkey {
  Get-Content $env:USERPROFILE\.ssh\id_rsa.pub | ssh $(Read-Host -Prompt 'Enter user@ip-address') 'cat >> $HOME/.ssh/authorized_keys'
}
Function ChangeHosts {
  sudo nvim $env:SystemRoot\System32\drivers\etc\hosts
}
Function GitPull {
  git.exe pull; if ($?) { Clear-Host }
}
Function GitStatus {
  git.exe status
}
Function CleanTemp {
  Remove-Item -Path $env:TEMP\* -Recurse -ErrorAction SilentlyContinue
}
Function Which ($command) {
  Get-Command -Name $command -ErrorAction SilentlyContinue |
  Select-Object -ExpandProperty Path -ErrorAction SilentlyContinue
}

Function UpdateAll {
  sudo winget.exe upgrade --recurse --source winget --verbose --include-unknown --ignore-security-hash
}

Function GitPush {
  git.exe add .; if ($?) { git.exe commit -am "Work with repository" }; if ($?) { git.exe push }; if ($?) { Clear-Host }
}
  
# setup PSReadLineOption
Set-PSReadLineOption -EditMode Emacs
Set-PSReadLineOption -PredictionSource HistoryAndPlugin
Set-PSReadLineOption -PredictionViewStyle ListView
Set-PSReadLineOption -HistoryNoDuplicates:$True
Set-PSReadLineOption -ShowToolTips:$True
#Get KeyHandlers 'Get-PSReadLineKeyHandler -Bound -Unbound'
Set-PSReadlineKeyHandler -Chord Ctrl+d -Function DeleteChar
Set-PSReadLineKeyHandler -Chord Ctrl+f -Function ForwardWord
Set-PSReadLineKeyHandler -Chord Enter -Function ValidateAndAcceptLine

# aliases
Set-Alias -Name vim -Value "$env:ProgramFiles\Neovim\bin\nvim.exe"
Set-Alias -Name cle -Value Clear-Host
Set-Alias -Name ll -Value Get-ChildItem
Set-Alias -Name cln -Value CleanTemp
Set-Alias -Name touch -Value New-Item
Set-Alias -Name gst -Value GitStatus
Set-Alias -Name ua -Value UpdateAll
Set-Alias -Name winin -Value WingetInstall
Set-Alias -Name winun -Value WingetUninstall
Set-Alias -Name winsr -Value WingetSearch
Set-Alias -Name gsh -Value GitPush
Set-Alias -Name gll -Value GitPull
Set-Alias -Name hosts -Value ChangeHosts
Set-Alias -Name sudo -Value "C:\Program Files\gsudo\Current\gsudo.exe"
Set-Alias -Name pubkey -Value SSHPubkey
Set-Alias -Name g -Value Git.exe
Set-Alias -Name gshss -Value GitPushSS

# starship
$ENV:STARSHIP_CONFIG = "$env:USERPROFILE\starship.toml"
function Invoke-Starship-PreCommand {
  $starship_title = Split-Path -Path $pwd -Leaf
  $host.ui.RawUI.WindowTitle = "$starship_title"
}
Invoke-Expression (&starship init powershell)
```

> [!IMPORTANT]
> Do the command below before use winget upgrade alias.

3. Restart Terminal and execute the command:
```powershell
sudo winget settings --enable InstallerHashOverride
```

## Install Brave Browser

```powershell
Invoke-WebRequest https://laptop-updates.brave.com/latest/winx64 -OutFile $env:USERPROFILE\Downloads; if ($?) { Start-Process "$env:USERPROFILE\Downloads\BraveBrowserSetup.exe" };
```

## Install PotPlayer

Direct link:

https://t1.daumcdn.net/potplayer/PotPlayer/Version/Latest/PotPlayerSetup64.exe

Powershell commands:

```powershell
Invoke-WebRequest https://t1.daumcdn.net/potplayer/PotPlayer/Version/Latest/PotPlayerSetup64.exe -OutFile $env:USERPROFILE\Downloads; if ($?) { Start-Process "$env:USERPROFILE\Downloads\PotPlayerSetup64.exe" "powershell" -Verb RunAs };
```

## Git configuration

```powershell
vim $env:USERPROFILE\.gitconfig
```

```properties
[user]
  name = ialobanov
  email = ivan.a.lobanov@gmail.com

[core]
  autocrlf = input # unix
  editor = nvim
  sshCommand = C:/Windows/System32/OpenSSH/ssh.exe # for windows

[alias]
  che = checkout
  cm = commit
  br = branch
  lg = log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit
  last = log -1 HEAD

[init]
  defaultBranch = main

[pull]
  rebase = true

[fetch]
  prune = true

[includeIf "gitdir:C:/Users/Ivan/solidsoft/"]
  path = C:/Users/Ivan/.gitconfig-work
```

```shell
git config --list --global
```

## Obsidian vault

1. Create directory:
```ps1
mkdir $env:USERPROFILE\vault-personal && mkdir -p $env:USERPROFILE\solidsoft\vault-solidsoft
```

2. Clone the repo:
```ps1
git clone git@github.com:ialobanov/obsidian-vault.git $env:USERPROFILE\vault-personal
```

## Add SSH key-pair

> [!TIP]
> Alternative - use a password manager's ssh-agent.

1. Run windows terminal as administrator to start ssh-Agent:
```powershell
Get-Service -Name ssh-agent | Set-Service -StartupType Automatic;
if ($?) { Start-Service ssh-agent };
```

2. Open windows terminal as a current user, create ssh key-pair and add it into ssh-Agent:
```powershell
ssh-keygen -t ed25519 -C "ivan.a.lobanov"
```

3. Add ssh-key to your profile:
```powershell
ssh-add $env:USERPROFILE\.ssh\id_ed25519
```

